#!/usr/bin/perl
use warnings;
use strict;

BEGIN {
	if ($ENV{DEBUG_LIBS}) {
		unshift(@INC, "$ENV{HOME}/git/perl-transit-gtfs/Transit-MapMaker/lib");
		unshift(@INC, "$ENV{HOME}/git/perl-transit-gtfs/Transit-GTFS/lib");
	}
}

use Carp qw(verbose);

use Transit::GTFS;
use Transit::MapMaker;
use Getopt::Long;
use YAML;

my $shell = My::Shell->new();
Getopt::Long::Configure("bundling", "gnu_compat");
Getopt::Long::GetOptions("h|help" => sub { $shell->cmd__help(); exit(0); });
$shell->run(@ARGV);

package My::Shell;
use List::MoreUtils qw(firstidx);
sub new {
	my $class = shift();
	my $self = bless({}, $class);
	return $self;
}
sub cmd__help {
	my ($self) = @_;
	print(<<"END");
usage:
	$0 list-maps
	$0 FILENAME COMMAND [ \; COMMAND ... ]
where COMMAND is one of:
	update
	gtfs-update
	force-gtfs-update
	gtfs-repopulate
	force-gtfs-repopulate
	update-map-layers
	refresh-styles
	refresh-transit-stop-styles
	refresh-transit-route-styles
	update-transit-stops
	update-transit-routes
END
}
sub run {
	my ($self, @args) = @_;
	my @next;
	my $semicolon = firstidx { $_ eq ";" } @args;
	if ($semicolon != -1) {
		splice(@args, $semicolon, 1);
		@next = splice(@args, $semicolon);
	}
	my $command = shift(@args);
	if ($command =~ /\./) {	# is a filename
		unshift(@args, $command);
		$command = "map";
	}
	die("no command specified; type '$0 help' for help.\n") unless defined $command;
	my $method = $self->find_method($command);
	die("no such command: '$command'; type '$0 help' for help.\n") unless $method;
	$self->$method(@args);

	if (@next) {
		$self->run(@next);
	}
}
sub find_method {
	my ($self, $command, $prefix) = @_;
	$command =~ s{-}{_}g;
	my $method_name = "cmd__" . $command;
	if (defined $prefix) {
		$method_name = "cmd_" . $prefix . "__" . $command;
	}
	return $self->can($method_name);
}
sub load_map_info {
	my ($self) = @_;
	return if $self->{maps};
	my $maps = YAML::LoadFile("maps.yaml");
	if (!$maps) {
		die("No maps.yaml data.\n");
	}
	$self->{maps} = $maps;
}
sub cmd__list_maps {
	my ($self) = @_;
	$self->load_map_info();
	foreach (sort { $a cmp $b } keys(%{$self->{maps}})) {
		print("$_\n");
	}
}
sub cmd__map {
	my ($self, $mapname, $subcommand, @args) = @_;
	die("no map name specified\n") unless defined $mapname;
	die("no subcommand specified\n") unless defined $subcommand;
	my $method = $self->find_method($subcommand);
	die("no such command: '$subcommand'\n") unless $method;

	$self->load_map_info();
	my $mapinfo = $self->{maps}->{$mapname};
	if (!$mapinfo) {
		die("no such map: '$mapname'\n");
	}
	my $mapmaker = Transit::MapMaker->new(filename => $mapname, %$mapinfo);
	$self->{mapmaker} = $mapmaker;

	$self->$method(@args);
}
sub cmd__update {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		warn("map contains no transit data.\n");
	}
	if ($mm->gtfs()) {
		$mm->gtfs()->update();
		$mm->gtfs()->repopulate();
	}
	$mm->download_map_data();
	$mm->plot_osm_layers();
	if ($mm->gtfs()) {
		$mm->update_transit_stops();
		$mm->update_transit_routes();
	}
	$mm->update_grid();
}
sub cmd__gtfs_update {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$gtfs->update();
}
sub cmd__force_gtfs_update {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$gtfs->force_update();
}
sub cmd__gtfs_repopulate {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$gtfs->repopulate();
}
sub cmd__force_gtfs_repopulate {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$gtfs->force_repopulate();
}
sub cmd__update_map_layers {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->download_map_data();
	$mm->plot_osm_layers();
}
sub cmd__update_openstreetmap_layers {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->download_map_data();
	$mm->plot_osm_maps();
}
sub cmd__refresh_styles {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->refresh_styles();
	$mm->update_map_border();
	$mm->update_map_background();
}
sub cmd__refresh_transit_stop_styles {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->refresh_transit_stop_styles();
}
sub cmd__refresh_transit_route_styles {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->refresh_transit_route_styles();
}
sub cmd__update_transit_stops {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$mm->update_transit_stops();
}
sub cmd__update_transit_routes {
	my ($self, @routes) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$mm->update_transit_routes(@routes);
}
sub cmd__update_transit {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	my $gtfs = $mm->gtfs();
	if (!$mm->gtfs()) {
		die("map contains no transit data.\n");
	}
	$mm->update_transit_stops();
	$mm->update_transit_routes();
}
sub cmd__update_grid {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->update_grid();
}
sub cmd__update_map_border {
	my ($self) = @_;
	my $mm = $self->{mapmaker};
	die("map MAPNAME must be specified.\n") unless $mm;
	$mm->update_map_border();
}

